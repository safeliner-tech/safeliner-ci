name: Safeliner Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:

permissions:
  contents: write
  packages: read
  pull-requests: write

jobs:
  scan:
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep

    steps:
      # Checks-out your repository
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          repository: ostrovskyde/test-vuln-fixes

      # Scan repo with Semgrep
      - name: scan
        run: |
          semgrep \
            --sarif --output report.sarif

      # Save report as pipeline artifact
      - name: save report as pipeline artifact
        uses: actions/upload-artifact@v4
        with:
          name: report.sarif
          path: report.sarif

  autofix:
    needs: scan
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ostrovskyde/safeliner-ci:0.0.4

    steps:
      - name: Generate Safeliner App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.SAFELINER_APP_ID }}
          private-key: ${{ secrets.SAFELINER_APP_SECRET }}
          owner: ${{ github.repository_owner }}
          repositories: |
            test-vuln-fixes
      
      # Checks-out your repository
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          repository: ostrovskyde/test-vuln-fixes
          token: ${{ steps.generate-token.outputs.token }}

      # Get Sarif report from scanner job
      - name: Download report
        uses: actions/download-artifact@v4
        with: 
          name: report.sarif

      - name: Ð¡heck Git
        env:
          WORKSPACE: ${{ github.workspace }}
        run: |
          git config --global --add safe.directory ${WORKSPACE}
          git status

      - name: Run Safeliner
        env:
          DFG_BUILDER_PATH: ${{ vars.DFG_BUILDER_PATH }}
          ANALYZE_HANDLER: ${{ vars.ANALYZE_HANDLER }}
          FEEDBACK_HANDLER: ${{ vars.FEEDBACK_HANDLER }}
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
        run: |
          cp /usr/bin/integration.py ./integration.py
          python /usr/bin/integration.py apply-report report.sarif
          rm -f ./integration.py

      - name: Push Changes
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          git config user.name '${{ steps.generate-token.outputs.app-slug }}[bot]'
          git config user.email '${{ steps.generate-token.outputs.user-id }}+${{ steps.generate-token.outputs.app-slug }}[bot]@users.noreply.github.com'
          git checkout -b "safeliner-fixes"
          git add -A
          git commit -m "Safeliner auto fixes for SAST issues"
          git push --set-upstream origin "safeliner-fixes"
          
  open-pr:
    needs: autofix
    runs-on: ubuntu-latest

    steps:
      - name: Generate Safeliner App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.SAFELINER_APP_ID }}
          private-key: ${{ secrets.SAFELINER_APP_SECRET }}
          owner: ${{ github.repository_owner }}
          repositories: |
            test-vuln-fixes
      
      # Checks-out branch with fixes
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          repository: ostrovskyde/test-vuln-fixes
          token: ${{ steps.generate-token.outputs.token }}
          ref: "safeliner-fixes"
      
      - name: Open PR
        env: 
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh pr create --title "Safeliner SAST auto-fixes" --body "Please check what Safeliner suggest to change in order to make your code secure" --base main
          